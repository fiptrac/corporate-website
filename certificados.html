<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Certificados | FIPTRAC</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:'Montserrat',sans-serif;
  background:#020617;
  color:#e5e7eb;
}

.certificados{
  max-width:1300px;
  margin:auto;
  padding:120px 20px 60px;
}

/* FILTROS */
.filters{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:16px;
  margin-bottom:30px;
}
select,input{
  background:#111827;
  border:1px solid #1f2937;
  color:#e5e7eb;
  padding:12px;
  border-radius:10px;
}
.btn{
  background:#ef4444;
  border:none;
  color:#fff;
  padding:12px;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
}
.btn:hover{ background:#dc2626 }

/* GRID */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:22px;
}
.card{
  background:linear-gradient(180deg,#111827,#020617);
  border:1px solid #1f2937;
  border-radius:18px;
  padding:22px;
}
.card h4{margin:0 0 8px;color:#fff}
.card p{margin:4px 0;font-size:14px;color:#9ca3af}

/* POPUP */
.popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  backdrop-filter:blur(6px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.popup-card{
  background:#020617;
  border:1px solid #1f2937;
  border-radius:22px;
  padding:30px;
  width:100%;
  max-width:480px;
  position:relative;
}
.popup-card form{display:grid;gap:14px}
.close-btn{
  position:absolute;
  top:14px;
  right:16px;
  background:none;
  border:none;
  color:#9ca3af;
  font-size:20px;
  cursor:pointer;
}
</style>
</head>

<body>

<section class="certificados">

  <!-- FILTROS (DIRECTORIO) -->
  <div class="filters">
    <select id="pais"><option>País</option></select>
    <select id="entidad"><option>Entidad</option></select>
    <select id="certificacion"><option>Certificado</option></select>
    <button class="btn" onclick="abrirFormulario()">Solicitar Registro</button>
  </div>

  <div class="grid" id="grid"></div>
</section>

<!-- POPUP -->
<div class="popup" id="popup">
  <div class="popup-card">
    <button class="close-btn" onclick="cerrar()">✕</button>
    <h3>Solicitud de Alta</h3>

    <form id="form">
      <select id="fPais" required></select>
      <select id="fEntidad" required></select>

      <select id="fCert" required></select>
      <input id="otroCert" placeholder="OTRO CERTIFICADO" style="display:none">

      <input id="servicio" placeholder="SERVICIO (CORTO)" required>
      <input id="empresa" placeholder="EMPRESA" required>
      <input id="telefono" placeholder="TELÉFONO" required>
      <input id="correo" type="email" placeholder="CORREO" required>

      <button class="btn">Enviar solicitud</button>
    </form>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyZoE_MxXBmx_ViCv0_PatQJ7AKDWUyELOwzLcwh3XCb-mB5bn9yz6TvBpKq2lm2FcE/exec";

let baseDatos = {};
let directorio = [];

/* ===== CARGA DIRECTORIO (FILTROS + GRID) ===== */
fetch(API)
  .then(r=>r.json())
  .then(data=>{
    directorio = data;
    cargarFiltros();
    pintar(directorio);
  });

function cargarFiltros(){
  pais.innerHTML="<option>País</option>";
  [...new Set(directorio.map(x=>x.PAÍS))].forEach(p=>pais.innerHTML+=`<option>${p}</option>`);
}

pais.onchange=()=>{
  entidad.innerHTML="<option>Entidad</option>";
  certificacion.innerHTML="<option>Certificado</option>";
  directorio.filter(x=>x.PAÍS===pais.value)
    .map(x=>x.ENTIDAD)
    .filter((v,i,a)=>a.indexOf(v)===i)
    .forEach(e=>entidad.innerHTML+=`<option>${e}</option>`);
  filtrar();
};

entidad.onchange=()=>{
  certificacion.innerHTML="<option>Certificado</option>";
  directorio
    .filter(x=>(pais.value==="País"||x.PAÍS===pais.value) && x.ENTIDAD===entidad.value)
    .map(x=>x.CERTIFICADO)
    .filter((v,i,a)=>a.indexOf(v)===i)
    .forEach(c=>certificacion.innerHTML+=`<option>${c}</option>`);
  filtrar();
};

certificacion.onchange=filtrar;

function filtrar(){
  let r = directorio;
  if(pais.value!=="País") r=r.filter(x=>x.PAÍS===pais.value);
  if(entidad.value!=="Entidad") r=r.filter(x=>x.ENTIDAD===entidad.value);
  if(certificacion.value!=="Certificado") r=r.filter(x=>x.CERTIFICADO===certificacion.value);
  pintar(r);
}

function pintar(lista){
  grid.innerHTML="";
  lista.forEach(p=>{
    grid.innerHTML+=`
      <div class="card">
        <h4>${p.EMPRESA}</h4>
        <p>${p.SERVICIO}</p>
        <p>${p.ENTIDAD}, ${p.PAÍS}</p>
        <p><b>${p.CERTIFICADO}</b></p>
        <p>${p.TELÉFONO}</p>
        <p>${p.CORREO}</p>
      </div>`;
  });
}

/* ===== POPUP (BASE DE DATOS) ===== */
function abrirFormulario(){
  popup.style.display="flex";

  fetch(API+"?catalogo=true")
    .then(r=>r.json())
    .then(cat=>{
      baseDatos = cat;

      fPais.innerHTML="<option>País</option>";
      Object.keys(baseDatos.paises).forEach(p=>fPais.innerHTML+=`<option>${p}</option>`);

      fCert.innerHTML="<option>Certificado</option>";
      baseDatos.certificados.forEach(c=>fCert.innerHTML+=`<option>${c}</option>`);
      fCert.innerHTML+=`<option>OTRO</option>`;
    });
}

fPais.onchange=()=>{
  fEntidad.innerHTML="<option>Entidad</option>";
  (baseDatos.paises[fPais.value]||[]).forEach(e=>fEntidad.innerHTML+=`<option>${e}</option>`);
};

fCert.onchange=e=>{
  otroCert.style.display = e.target.value==="OTRO"?"block":"none";
};

servicio.oninput=()=>servicio.value=servicio.value.toUpperCase();
otroCert.oninput=()=>otroCert.value=otroCert.value.toUpperCase();

/* ===== SUBMIT ===== */
form.onsubmit=e=>{
  e.preventDefault();

  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      PAÍS:fPais.value,
      ENTIDAD:fEntidad.value,
      CERTIFICADO:fCert.value==="OTRO"?otroCert.value:fCert.value,
      SERVICIO:servicio.value,
      EMPRESA:empresa.value,
      TELÉFONO:telefono.value,
      CORREO:correo.value
    })
  }).then(()=>{
    alert("Solicitud enviada correctamente");
    cerrar();
    form.reset();
  });
};

function cerrar(){ popup.style.display="none"; }
popup.onclick=e=>{ if(e.target===popup) cerrar(); };
document.onkeydown=e=>{ if(e.key==="Escape") cerrar(); };
</script>

</body>
</html>
